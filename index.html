<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEXUS // SIMULATOR</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>

    <style>
        :root {
            --bg: #0d1117;
            --panel: #161b22;
            --border: #30363d;
            --text: #c9d1d9;
            --green: #238636;
            --green-text: #3fb950;
            --red: #da3633;
            --red-text: #f85149;
            --blue: #58a6ff;
            --font-ui: 'Inter', sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: var(--bg); color: var(--text); font-family: var(--font-ui); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* HEADER */
        header {
            height: 50px; border-bottom: 1px solid var(--border); background: var(--panel);
            display: flex; align-items: center; justify-content: space-between; padding: 0 20px;
        }
        .logo { font-family: var(--font-mono); font-weight: 700; color: #fff; }
        .logo span { color: var(--blue); }
        .balance-area { font-family: var(--font-mono); font-size: 14px; }
        .cash-label { color: var(--text); opacity: 0.7; font-size: 11px; margin-right: 5px; }

        /* GRID LAYOUT */
        .grid {
            display: grid;
            grid-template-columns: 1fr 300px; /* Chart | Controls */
            grid-template-rows: 1fr 200px;    /* Chart | Logs */
            height: calc(100vh - 50px);
            gap: 1px; background: var(--border);
        }

        /* CHART SECTION */
        .chart-panel { grid-column: 1 / 2; grid-row: 1 / 2; background: var(--bg); position: relative; }
        #chart { width: 100%; height: 100%; }
        .ticker-info {
            position: absolute; top: 15px; left: 20px; z-index: 10;
            font-family: var(--font-mono); pointer-events: none;
        }
        .current-price { font-size: 24px; font-weight: 700; color: #fff; }

        /* CONTROLS (RIGHT) */
        .controls-panel {
            grid-column: 2 / 3; grid-row: 1 / -1; background: var(--panel);
            display: flex; flex-direction: column; padding: 20px; border-left: 1px solid var(--border);
        }
        
        .stat-box { margin-bottom: 25px; background: var(--bg); padding: 15px; border: 1px solid var(--border); border-radius: 6px; }
        .stat-label { font-size: 11px; color: #8b949e; margin-bottom: 5px; text-transform: uppercase; }
        .stat-val { font-family: var(--font-mono); font-size: 18px; font-weight: 600; }
        .pnl-pos { color: var(--green-text); }
        .pnl-neg { color: var(--red-text); }

        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: auto; }
        button {
            border: none; padding: 15px; border-radius: 6px; cursor: pointer;
            font-family: var(--font-mono); font-weight: 700; font-size: 14px;
            color: white; transition: opacity 0.2s;
        }
        button:hover { opacity: 0.9; }
        button:active { transform: scale(0.98); }
        
        .btn-buy { background: var(--green); }
        .btn-sell { background: var(--red); }
        .btn-close { background: var(--blue); grid-column: 1 / -1; margin-top: 10px; }

        /* LOGS (BOTTOM) */
        .logs-panel {
            grid-column: 1 / 2; grid-row: 2 / 3; background: var(--bg);
            border-top: 1px solid var(--border); padding: 10px; font-family: var(--font-mono); font-size: 12px;
            overflow-y: auto; display: flex; flex-direction: column-reverse; /* Newest at bottom visually */
        }
        .log-line { margin-bottom: 4px; border-bottom: 1px solid rgba(255,255,255,0.05); padding: 4px 0; }
        .log-ts { color: var(--blue); margin-right: 10px; opacity: 0.7; }
        
        /* Mobile */
        @media (max-width: 800px) {
            .grid { display: flex; flex-direction: column; height: auto; }
            .chart-panel { height: 350px; }
            .logs-panel { height: 150px; }
        }
    </style>
</head>
<body>

    <header>
        <div class="logo">NEXUS <span>SIM</span></div>
        <div class="balance-area">
            <span class="cash-label">AVAILABLE CASH</span>
            <span id="cash-display">$10,000.00</span>
        </div>
    </header>

    <div class="grid">
        <div class="chart-panel">
            <div class="ticker-info">
                <div style="font-size:12px; color:#8b949e; margin-bottom:4px;">SYNTHETIC ASSET (NXS)</div>
                <div class="current-price" id="price-header">100.00</div>
            </div>
            <div id="chart"></div>
        </div>

        <div class="controls-panel">
            
            <div class="stat-box">
                <div class="stat-label">Position Size</div>
                <div class="stat-val" id="pos-size">0</div>
            </div>

            <div class="stat-box">
                <div class="stat-label">Avg Entry Price</div>
                <div class="stat-val" id="avg-entry">--</div>
            </div>

            <div class="stat-box">
                <div class="stat-label">Unrealized PnL</div>
                <div class="stat-val" id="unrealized-pnl">$0.00</div>
            </div>

            <div class="stat-box" style="border-color: var(--blue);">
                <div class="stat-label">Realized PnL (Total)</div>
                <div class="stat-val" id="realized-pnl">$0.00</div>
            </div>

            <div class="btn-group">
                <button class="btn-buy" onclick="trade('buy')">BUY</button>
                <button class="btn-sell" onclick="trade('sell')">SELL</button>
                <button class="btn-close" onclick="closeAll()">CLOSE POSITION</button>
            </div>
        </div>

        <div class="logs-panel" id="logs">
            </div>
    </div>

    <script>
        // --- 1. CONFIGURATION DU CHART ---
        const chartContainer = document.getElementById('chart');
        const chart = LightweightCharts.createChart(chartContainer, {
            layout: { background: { type: 'solid', color: '#0d1117' }, textColor: '#8b949e' },
            grid: { vertLines: { color: '#161b22' }, horzLines: { color: '#161b22' } },
            crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
            rightPriceScale: { borderColor: '#30363d' },
            timeScale: { borderColor: '#30363d', timeVisible: true, secondsVisible: true },
        });

        const candleSeries = chart.addCandlestickSeries({
            upColor: '#238636', downColor: '#da3633',
            wickUpColor: '#238636', wickDownColor: '#da3633', borderVisible: false
        });

        new ResizeObserver(entries => {
            if (entries.length === 0 || entries[0].target !== chartContainer) return;
            const newRect = entries[0].contentRect;
            chart.applyOptions({ width: newRect.width, height: newRect.height });
        }).observe(chartContainer);

        // --- 2. GAME STATE (Données du jeu) ---
        let cash = 10000;
        let position = 0; // Nombre d'actions
        let avgEntryPrice = 0;
        let totalRealizedPnL = 0;
        
        let currentPrice = 100.00;
        let lastCandle = null;
        let lastTickTime = Math.floor(Date.now() / 1000);

        // --- 3. GENERATEUR DE PRIX (Moteur Physique) ---
        // On initialise avec 100 bougies passées pour que le graphique ne soit pas vide
        let data = [];
        let t = lastTickTime - (100 * 60);
        let p = 100;
        
        for(let i=0; i<100; i++) {
            let change = (Math.random() - 0.5) * 0.8; // Volatilité
            let open = p;
            let close = p + change;
            let high = Math.max(open, close) + Math.random() * 0.5;
            let low = Math.min(open, close) - Math.random() * 0.5;
            
            data.push({ time: t, open, high, low, close });
            p = close;
            t += 60;
        }
        candleSeries.setData(data);
        lastCandle = data[data.length - 1];
        currentPrice = lastCandle.close;

        // Fonction qui tourne en boucle pour faire vivre le prix
        setInterval(() => {
            // Random Walk Algorithm
            let volatility = 0.2; 
            let change = (Math.random() - 0.5) * volatility;
            
            currentPrice += change;
            
            // Mise à jour de la bougie courante
            let now = Math.floor(Date.now() / 1000);
            
            // Si on change de minute, nouvelle bougie
            if (now >= lastCandle.time + 60) {
                lastCandle = {
                    time: Math.floor(now / 60) * 60,
                    open: currentPrice,
                    high: currentPrice,
                    low: currentPrice,
                    close: currentPrice
                };
            } else {
                // Mise à jour bougie existante
                lastCandle.close = currentPrice;
                lastCandle.high = Math.max(lastCandle.high, currentPrice);
                lastCandle.low = Math.min(lastCandle.low, currentPrice);
            }
            
            candleSeries.update(lastCandle);
            updateUI();
        }, 200); // 5 ticks par seconde

        // --- 4. LOGIQUE DE TRADING ---

        function trade(type) {
            const qty = 10; // On achète/vend par paquet de 10
            const tradeValue = qty * currentPrice;

            if (type === 'buy') {
                if (cash < tradeValue) {
                    log("ERROR: Not enough cash!", true);
                    return;
                }
                
                // Calcul du nouveau prix d'entrée moyen
                let oldTotal = position * avgEntryPrice;
                let newTotal = oldTotal + tradeValue;
                position += qty;
                avgEntryPrice = newTotal / position;
                
                cash -= tradeValue;
                log(`EXECUTED: BUY ${qty} @ ${currentPrice.toFixed(2)}`);
            } 
            
            if (type === 'sell') {
                if (position < qty) { // On autorise le Short Selling dans ce jeu ? Non, restons simple.
                    // Si on n'a pas d'actions, on Short (Vente à découvert)
                    // Pour simplifier ici: Si position > 0 on vend, sinon on short
                }

                // Logique simplifiée: On vend ce qu'on a, ou on short
                // Pour simplifier le code "realized PnL", on va dire qu'on ferme une partie de la position
                
                // --- SCENARIO 1 : J'ai des actions (LONG), je vends pour prendre profit ---
                if (position > 0) {
                    let amountToSell = Math.min(position, qty);
                    
                    // Calcul PnL sur cette partie
                    let pnlOnTrade = (currentPrice - avgEntryPrice) * amountToSell;
                    totalRealizedPnL += pnlOnTrade;
                    cash += (amountToSell * currentPrice);
                    position -= amountToSell;
                    
                    if (position === 0) avgEntryPrice = 0;
                    
                    log(`EXECUTED: SELL ${amountToSell} @ ${currentPrice.toFixed(2)} | PnL: $${pnlOnTrade.toFixed(2)}`);
                } 
                // --- SCENARIO 2 : Je n'ai rien (ou suis short), je vends à découvert ---
                else {
                    // Pour cet exemple simple, interdisons le short pour éviter la complexité mathématique
                    // et forçons l'utilisateur à acheter d'abord.
                     // Mais pour le fun, on peut simplement dire qu'on vend
                     let pnlOnTrade = (currentPrice - avgEntryPrice) * qty;
                     if(position < 0) {
                         // Adding to short
                         let oldTotal = Math.abs(position) * avgEntryPrice;
                         let newTotal = oldTotal + tradeValue;
                         position -= qty;
                         avgEntryPrice = newTotal / Math.abs(position);
                         cash += tradeValue; // Shorting adds cash (liability increases)
                     } else {
                         // Starting short
                         position -= qty;
                         avgEntryPrice = currentPrice;
                         cash += tradeValue;
                     }
                     log(`EXECUTED: SHORT ${qty} @ ${currentPrice.toFixed(2)}`);
                }
            }
            updateUI();
        }

        function closeAll() {
            if (position === 0) return;
            
            let pnl = 0;
            if (position > 0) {
                // Closing Long
                pnl = (currentPrice - avgEntryPrice) * position;
                cash += (position * currentPrice);
            } else {
                // Closing Short
                pnl = (avgEntryPrice - currentPrice) * Math.abs(position);
                cash -= (Math.abs(position) * currentPrice);
            }
            
            totalRealizedPnL += pnl;
            log(`POSITION CLOSED. Realized PnL: $${pnl.toFixed(2)}`);
            
            position = 0;
            avgEntryPrice = 0;
            updateUI();
        }

        // --- 5. UI UPDATES ---
        function updateUI() {
            // Header Price
            document.getElementById('price-header').innerText = currentPrice.toFixed(2);
            document.getElementById('cash-display').innerText = '$' + cash.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});

            // Stats
            document.getElementById('pos-size').innerText = position;
            document.getElementById('avg-entry').innerText = avgEntryPrice > 0 ? avgEntryPrice.toFixed(2) : '--';

            // Unrealized PnL Calc
            let unrealized = 0;
            if (position !== 0) {
                if (position > 0) unrealized = (currentPrice - avgEntryPrice) * position;
                else unrealized = (avgEntryPrice - currentPrice) * Math.abs(position);
            }
            
            const pnlEl = document.getElementById('unrealized-pnl');
            pnlEl.innerText = '$' + unrealized.toFixed(2);
            pnlEl.className = 'stat-val ' + (unrealized >= 0 ? 'pnl-pos' : 'pnl-neg');

            // Realized PnL
            const realEl = document.getElementById('realized-pnl');
            realEl.innerText = '$' + totalRealizedPnL.toFixed(2);
            realEl.className = 'stat-val ' + (totalRealizedPnL >= 0 ? 'pnl-pos' : 'pnl-neg');
        }

        function log(msg, isError=false) {
            const box = document.getElementById('logs');
            const div = document.createElement('div');
            div.className = 'log-line';
            div.style.color = isError ? '#da3633' : '#c9d1d9';
            
            const time = new Date().toLocaleTimeString().split(' ')[0];
            div.innerHTML = `<span class="log-ts">${time}</span> ${msg}`;
            
            box.prepend(div);
        }

    </script>
</body>
</html>
